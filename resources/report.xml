<?xml version="1.0" encoding="UTF-8" ?>
<Report>
    <Title><var var="I18N::translate('Family Research Tasks Report')" /></Title>
    <Description><var var="I18N::translate('Research tasks Report with filters and other options')" /></Description>

    <!--SetVar name="showAllFamilies" value="" /-->
    <SetVar name="showAllFamilies" value="on" />
    <SetVar name="fid" value="" />
    
    <Input name="withParents" type="checkbox" default="1"><var var="I18N::translate('Show parents')" /></Input>
    <Input name="showXref" type="checkbox" default="1"><var var="I18N::translate('Show XREF')" /></Input>
    <Input name="showFilters" type="checkbox" default="1"><var var="I18N::translate('Show Filters')" /></Input>
    <Input name="hideEmptyDates" type="checkbox" default="1"><var var="I18N::translate('Hide records without a date')" /></Input>
    <Input name="includeAllNamesIndi" type="checkbox" default="0"><var var="I18N::translate('Include all names on individuals')" /></Input>
    <Input name="showAllIndividuals" type="checkbox" default="0"><var var="I18N::translate('Show all individuals')" /></Input>
    <Input name="pid" lookup="INDI" type="text" default=""><var var="I18N::translate('Individual')" /></Input>
<!-- It does't let leave empty the family input field
    Haven't managed to show a default family. It could be the parents family, or any other one related to the default/selected individual.

    <SetVar name="family" value="$individual->childFamilies()->first()" />
    <SetVar name="xref" value="$individual->childFamilies()->first()->xref()" />
-->
    <Input name="showAllFamilies" type="checkbox" default="1"><var var="I18N::translate('Show all families')" /></Input>
<!--
    <Input name="fid" lookup="FAM" type="text" default="$xref"><var var="I18N::translate('Family')" /> <var var="$family" /> HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE HERE</Input>
                    <?= view('components/select-family', [
                        'id'       => 'input-7',
                        'name'     => 'vars["fid"]',
                        'family'   => Registry::familyFactory()->make("F1", $tree),
                        'family'   => $individual->childFamilies()->first(),
                        'tree'     => $tree,
                        'required' => true,
                    ]); ?>
                    <?= view('../../../resources/views/components/select-family', [
                        'id'       => 'input-7',
                        'name'     => 'vars["fid"]',
                        'family'   => $individual->childFamilies()->first(),
                        'tree'     => $tree,
                        'required' => true,
                    ]); ?>
-->
    <Input name="filter_rt" type="text" default=""><var var="I18N::translate('Research Task Filter')" /></Input>
    <Input name="date1" lookup="DATE" type="text"><var var="I18N::translate('Research task creation date range start')" /></Input>
    <Input name="date2" lookup="DATE" type="text"><var var="I18N::translate('Research task creation date range end')" /></Input>

    <Input name="sortby" type="select" default="NAME" options="NAME=>I18N::translate('sort by lastname')|_TODO:DATE=>I18N::translate('sort date (only takes first research task)')|_TODO=>I18N::translate('sort by text (only takes first research task)')|_TODO:NOTE=>I18N::translate('sort by note (only takes first research task)')|_TODO:_WT_USER=>I18N::translate('sort by user (only takes first research task)')"><var var="I18N::translate('Sort order')" /></Input>
    <Input name="pageSize" type="select" options="A4=>I18N::translateContext('paper size','A4')|A3=>I18N::translateContext('paper size', 'A3')|US-Letter=>I18N::translateContext('paper size','Letter')|US-Tabloid=>I18N::translateContext('paper size','Tabloid')"><var var="I18N::translate('Page size')" /></Input>

    <SetVar name="fonts" value="DejaVuSans" />

    <!-- Header -->
    <Style name="header" font="$fonts" size="18" style="b"/>
    <!-- Generated by style - required style name by the generator -->
    <Style name="genby" font="$fonts" size="8" />
    <!-- Links to sources - required style name by the generator -->
    <Style name="footnotenum" font="$fonts" size="6" />
    <!-- Source text - FootnoteTexts - required style name by the generator -->
    <Style name="footnote" font="$fonts" size="8" />
    <!-- Page numbers text -->
    <Style name="pagenum" font="$fonts" size="8" />
    <!-- Page Header text -->
    <Style name="pageheader" font="$fonts" size="14"/>
    <!-- Individual names in text boxes -->
    <Style name="name" font="$fonts" size="10" style="b"/>
    <!-- Individual names in text boxes no bold -->
    <Style name="name2" font="$fonts" size="10"/>
    <!-- Standard text -->
    <Style name="text" font="$fonts" size="9" />
    <!-- Facts text -->
    <Style name="fact" font="$fonts" size="8"/>
    <!-- Date -->
    <Style name="date" font="$fonts" size="8"/>

    <!-- Column labels -->
    <Style name="label" font="$fonts" size="10" style="b"/>

    <!-- set the default widths -->
    <SetVar name="width" value="0" />
    <SetVar name="width1" value="0" />
    <SetVar name="width2" value="0" />
    <SetVar name="dwidth" value="185" />
    <SetVar name="pwidth" value="436" />

    <SetVar name="pageOrientation" value="landscape"/>

    <if condition="@format=='HTML'">
        <SetVar name="pageSize" value="A3"/>
        <SetVar name="pageOrientation" value="portrait"/>
    </if>
    <if condition="$pageSize=='A3' or $pageSize=='US-Tabloid'">
        <SetVar name="dwidth" value="285"/>
        <SetVar name="pwidth" value="636"/>
        <SetVar name="width" value="633"/>
        <SetVar name="width1" value="618"/>
        <SetVar name="width2" value="333"/>
    </if>

    <SetVar name="tcolor" value=""/>
    <SetVar name="tcolor_parents" value="#686868"/>

    <SetVar name="trunc_name" value="20" />

    <SetVar name="urlbase" value="@base_url"/>


    <Doc pageSize="$pageSize" orientation="$pageOrientation">
        <!-- Sevtor Reports ignores the header when the output is PDF -->
        <Header   comment="only used for html output" >
            <Textbox newline="1" pos="rel">
                <Text style="header"><var var="I18N::translate('Research tasks Report')" /></Text>
            </Textbox>
            <Cell align="rightrtl" newline="1" style="pagenum"><var var="I18N::translate('Page')" /> <PageNum /> <var var="I18N::translate('of')" /> <TotalPages /></Cell>
        </Header>

        <Body>

            <!-- /////////////////////////////////////////////////////////// -->
            <!-- //// Handle Individual list                            //// -->
            <!-- /////////////////////////////////////////////////////////// -->

                    <TextBox bgcolor="$malebox_bgcolor" border="1" left ="0" width="0" newline="1" pos="abs" top=".">
                        <Text color="$tcolor" style="text"><var var="I18N::translate('Individuals')" />  </Text>
                    </TextBox>
            
            <if condition="$showXref=='on'">
                <SetVar name="fill" value="" />
                <Cell bgcolor="$fill" fill="1" border="1" width="30" style="label"><var var="I18N::translate('XREF')" /></Cell>
            </if>
            <SetVar name="fill" value="" />
            <if condition="$sortby=='NAME'"><SetVar name="fill" value="#AAAAAA" /></if>
            <Cell bgcolor="$fill" fill="1" border="1" width="200" style="label"><var var="I18N::translate('Name')" /></Cell>

            <SetVar name="fill" value="" />
            <if condition="$sortby=='_TODO'"><SetVar name="fill" value="#AAAAAA" /></if>
            <Cell bgcolor="$fill" fill="1" border="1" width="200" style="label"><var var="I18N::translate('Research Task')" /></Cell>

            <SetVar name="fill" value="" />
            <if condition="$sortby=='_TODO:NOTE'"><SetVar name="fill" value="#AAAAAA" /></if>
            <Cell bgcolor="$fill" fill="1" border="1" width="200" style="label"><var var="I18N::translate('Note')" /></Cell>

            <SetVar name="fill" value="" />
            <if condition="$sortby=='_TODO:DATE' or $sortby=='_TODO%3ADATE'"><SetVar name="fill" value="#AAAAAA" /><SetVar name="sortby" value="_TODO:DATE" /></if>
            <Cell bgcolor="$fill" fill="1" border="1" width="80" style="label"><var var="I18N::translate('Date')" /></Cell>

            <SetVar name="fill" value="" />
            <if condition="$sortby=='_TODO:_WT_USER'"><SetVar name="fill" value="#AAAAAA" /></if>
            <Cell bgcolor="$fill" fill="1" border="1" width="100" newline="1" style="label"><var var="I18N::translate('User')" /></Cell>

            <if condition="$showAllIndividuals=='on'">
                <SetVar name="pid" value="" />
            </if>
            <if condition="$showAllFamilies=='on'">
                <SetVar name="fid" value="" />
            </if>
            <SetVar name="hideEmptyDatesFilter" value="" />
            <if condition="$hideEmptyDates=='on'">
                <SetVar name="hideEmptyDatesFilter" value="_TODO:DATE NE ''" />
            </if>
<!--  filter6="NAME CONTAINS $name" filter7="_TODO:_WT_USER CONTAINS $filter_indi_createdby" DON'T WORK -->
            <List list="individual" filter0="LIKE /%\n1 _TODO%/" filter1="XREF EQ $pid" sortby="$sortby">

<!--
       fIlter4="NAME CONTAINS $name"  
 filter5="_TODO:_WT_USER CONTAINS $filter_indi_createdby"
-->

                <!-- INITIALIZE XREF COLUMN VALUE -->
                <SetVar name="id" value="@ID"/>

                <!-- INITIALIZE NAME COLUMN VALUE -->
                <if condition="$includeAllNamesIndi!='on'">
                    <GetPersonName id="" setvar="Name" />
                </if>
                <if condition="$includeAllNamesIndi=='on'">
                    <SetVar name="usebr" value="1"/>
                    <GetAllPersonNames id="" setvar="Name" />
                </if>
                <SetVar name="Father" value="" />
                <SetVar name="Mother" value="" />
                <if condition="$withParents=='on'">
                    <Gedcom id="@FAMC">
                        <SetVar name="Father" value="I18N::translate('Father')" />
                        <SetVar name="Mother" value="I18N::translate('Mother')" />
                        <GetPersonName id="@HUSB" truncate="$trunc_name" setvar="Father" varappend=": " />
                        <GetPersonName id="@WIFE" truncate="$trunc_name" setvar="Mother" varappend=": " />
                    </Gedcom>
                </if>

                <!-- THERE CAN BE MORE THAN ONE _TODO ENTRY -->
                <RepeatTag tag="_TODO" filter5="$hideEmptyDatesFilter" filter4="_TODO CONTAINS_R NEEDLE='$filter_rt' HAYSTACK_WANT_R='2 CONT|2 NOTE|3 CONT' HAYSTACK_DONT_WANT_R='2 DATE|2 _WT_USER' REPEAT_W_DW_R=3 HAYSTACK_REPLACE_R='\1\2\3' REMOVE_WANT_IN_HAYSTACK=1" filter2="_TODO:DATE GTE $date1" filter3="_TODO:DATE LTE $date2">

                    <!-- XREF -->
                    <if condition="$showXref=='on'">
                        <Cell width="30" style="text"><var var="$id" /></Cell>
                    </if>

                    <!-- NAME -->
                    <SetVar name="url" value="$urlbase/individual/$id" />
                    <Cell width="200" stretch="0" style="name2" height="0"><SetVar name="usebr" value="0"/><url url="$url"><var var="$Name" keephtml="true" /></url><if condition="$withParents=='on'"><br /><var var="$Father" /><br /><var var="$Mother" /></if></Cell>
    
                    <!-- RESEARCH TASK -->
                    <Cell width="200" style="text"><GedcomValue tag="_TODO" /></Cell>
    
                    <!-- NOTE -->
                    <Cell width="200" style="text">
                        <!-- Only with multiple sources use line feed (br) -->
                        <SetVar name="usebr" value="0"/>
                        <RepeatTag tag="_TODO:NOTE">
                            <GedcomValue tag="NOTE" />
                        </RepeatTag>
                    </Cell>
    
                    <!-- DATE -->
                    <Cell width="80" style="text"><GedcomValue tag="_TODO:DATE" truncate="d" /></Cell>
    
                    <!-- USER -->
                    <Cell newline="1" width="100" style="text"><GedcomValue tag="_TODO:_WT_USER" newline="1" /></Cell>
    
                    <!-- SET VARIABLES SO FROM THE SECOND _TODO ENTRY ON, THE XREF AND NAME COLUMNS ARE EMPTY -->
                    <SetVar name="id" value="" />
                    <SetVar name="Name" value="" />
                    <SetVar name="Father" value="" />
                    <SetVar name="Mother" value="" />
                </RepeatTag>
            </List>
            <Cell align="rightrtl" height="24" newline="1" style="label"><br/><var var="I18N::translate('Total individuals')"/>: <ListTotal/></Cell>


            <!-- /////////////////////////////////////////////////////////// -->
            <!-- //// Handle Family list                                //// -->
            <!-- /////////////////////////////////////////////////////////// -->

            <ListTotalReset />

                    <TextBox bgcolor="$malebox_bgcolor" border="1" left ="0" width="0" newline="1" pos="abs" top=".">
                        <Text color="$tcolor" style="text"><var var="I18N::translate('Families')" />  </Text>
                    </TextBox>
            
            <if condition="$showXref=='on'">
                <SetVar name="fill" value="" />
                <Cell bgcolor="$fill" fill="1" border="1" width="30" style="label"><var var="I18N::translate('XREF')" /></Cell>
            </if>
            <SetVar name="fill" value="" />
            <if condition="$sortby=='NAME'"><SetVar name="fill" value="#AAAAAA" /></if>
            <Cell bgcolor="$fill" fill="1" border="1" width="200" style="label"><var var="I18N::translate('Name')" /></Cell>

            <SetVar name="fill" value="" />
            <if condition="$sortby=='_TODO'"><SetVar name="fill" value="#AAAAAA" /></if>
            <Cell border="1" width="200" style="label"><var var="I18N::translate('Research Task')" /></Cell>

            <SetVar name="fill" value="" />
            <if condition="$sortby=='_TODO:NOTE'"><SetVar name="fill" value="#AAAAAA" /></if>
            <Cell border="1" width="200" style="label"><var var="I18N::translate('Note')" /></Cell>

            <SetVar name="fill" value="" />
            <if condition="$sortby=='_TODO:DATE'"><SetVar name="fill" value="#AAAAAA" /></if>
            <Cell bgcolor="$fill" fill="1" border="1" width="80" style="label"><var var="I18N::translate('Date')" /></Cell>

            <SetVar name="fill" value="" />
            <if condition="$sortby=='_TODO:_WT_USER'"><SetVar name="fill" value="#AAAAAA" /></if>
            <Cell bgcolor="$fill" fill="1" border="1" width="100" newline="1" style="label"><var var="I18N::translate('User')" /></Cell>

<!--  filter6="NAME CONTAINS $name" filter7="_TODO:_WT_USER CONTAINS $filter_fam_createdby" DON'T WORK -->
            <List list="family" filter0="LIKE /%\n1 _TODO%/" filter1="XREF EQ $fid" sortby="$sortby">

                <!-- INITIALIZE XREF COLUMN VALUE -->
                <SetVar name="id" value="@ID"/>

                <!-- INITIALIZE NAME COLUMN VALUE -->
                <GetPersonName id="" setvar="Name"/>

                <!-- THERE CAN BE MORE THAN ONE _TODO ENTRY -->
                <RepeatTag tag="_TODO" filter5="$hideEmptyDatesFilter" filter4="_TODO CONTAINS_R NEEDLE='$filter_rt' HAYSTACK_WANT_R='2 CONT|2 NOTE|3 CONT' HAYSTACK_DONT_WANT_R='2 DATE|2 _WT_USER' REPEAT_W_DW_R=3 HAYSTACK_REPLACE_R='\1\2\3' REMOVE_WANT_IN_HAYSTACK=1" filter2="_TODO:DATE GTE $date1" filter3="_TODO:DATE LTE $date2">

                    <!-- XREF -->
                    <if condition="$showXref=='on'">
                        <Cell width="30" style="text"><var var="$id" /></Cell>
                    </if>

                    <!-- NAME -->
                    <SetVar name="url" value="$urlbase/individual/$id" />
                    <Cell width="200" stretch="0" style="name2" height="0" url="$url"><SetVar name="usebr" value="0"/><var var="$Name" /></Cell>
    
                    <!-- RESEARCH TASK -->
                    <Cell width="200" style="text"><GedcomValue tag="_TODO" /></Cell>
    
                    <!-- NOTE -->
                    <Cell width="200" style="text">
                        <!-- Only with multiple sources use line feed (br) -->
                        <SetVar name="usebr" value="0"/>
                        <RepeatTag tag="_TODO:NOTE">
                            <GedcomValue tag="NOTE" />
                        </RepeatTag>
                    </Cell>
    
                    <!-- DATE -->
                    <Cell width="80" style="text"><GedcomValue tag="_TODO:DATE" truncate="d" /></Cell>
    
                    <!-- USER -->
                    <Cell newline="1" width="100" style="text"><GedcomValue tag="_TODO:_WT_USER" newline="1" /></Cell>
    
                    <!-- INITIALIZE VARIABLES SO FROM THE SECOND _TODO ENTRY ON, THE XREF AND NAME COLUMNS ARE EMPTY -->
                    <SetVar name="id" value="" />
                    <SetVar name="Name" value="" />
                    <SetVar name="Father" value="" />
                    <SetVar name="Mother" value="" />
                </RepeatTag>
            </List>
            <Cell align="rightrtl" height="24" newline="1" style="label"><br/><var var="I18N::translate('Total families')"/>: <ListTotal/></Cell>

            <if condition="$showFilters=='on'">
                    <TextBox bgcolor="$malebox_bgcolor" border="1" left ="0" width="0" newline="1" pos="abs" top=".">
                        <Text color="$tcolor" style="text"><var var="I18N::translate('Report Parameters')" />  </Text>
                    </TextBox>
                <TextBox bgcolor="$malebox_bgcolor" border="0" left ="0" width="0" newline="1">
                </TextBox>
                <Cell newline="1" style="text">
                    <var var="I18N::translate('Show parents')" />: [<if condition="$withParents=='on'">&#x221a;</if><if condition="$withParents!='on'"> </if>]                             <br />
                    <var var="I18N::translate('Show XREF')" />: [<if condition="$showXref=='on'">&#x221a;</if><if condition="$showXref!='on'"> </if>]                                   <br />
                    <var var="I18N::translate('Show Filters')" />: [<if condition="$showFilters=='on'">&#x221a;</if><if condition="$showFilters!='on'"> </if>]                             <br />
                    <var var="I18N::translate('Hide records without a date')" />: [<if condition="$hideEmptyDates=='on'">&#x221a;</if><if condition="$hideEmptyDates!='on'"> </if>]           <br />
                    <!--var var="I18N::translate('Name')" />: [<var var="$name"/>]                                                                  <br /-->
                    <var var="I18N::translate('Include all names on individuals')" />: [<if condition="$includeAllNamesIndi=='on'">&#x221a;</if><if condition="$includeAllNamesIndi!='on'"> </if>]              <br />
                    <var var="I18N::translate('Show all individuals')" />: [<if condition="$showAllIndividuals=='on'">&#x221a;</if><if condition="$showAllIndividuals!='on'"> </if>]              <br />
                    <var var="I18N::translate('Individual')" />: [<if condition="$pid!=''"><var var="$pid"/> - <GetPersonName id="$pid" /></if>] <br />
                    <var var="I18N::translate('Show All Families')" />: [<if condition="$showAllFamilies=='on'">&#x221a;</if><if condition="$showAllFamilies!='on'"> </if>] <br />
<!--
                    <var var="I18N::translate('Family')" />: [<GetPersonName id="$fid" />]                                                       <br />
                    <var var="I18N::translate('Research task created by (individual)')" />: [<var var="$filter_indi_createdby"/>]                <br />
                    <var var="I18N::translate('Research task created by (family)')" />: [<var var="$filter_fam_createdby"/>]                     <br />
-->
            
                    <var var="I18N::translate('Research task creation date range start')" />: [<var var="$date1"/>]                              <br />
                    <var var="I18N::translate('Research task creation date range end')" />: [<var var="$date2"/>]                                <br />
                    <var var="I18N::translate('Research Task Filter')" />: [<var var="$filter_rt"/>]                                             <br />
                    <var var="I18N::translate('Sort order')" />: [<var var="$sortby"/>]                                                          <br /><br />
                    <if condition="$sortby=='_TODO:DATE' or $sortby=='_TODO' or $sortby=='_TODO:NOTE' or $sortby=='_TODO:_WT_USER'">
                        <var var="I18N::translate('About sort: It takes the first fact of each individual or family to sort, ignores the rest and sends empty values to the end.')" /> <br />
                    </if>

                    <if condition="@format!='HTML'">
                        <var var="I18N::translate('Page size')" />: [<var var="$pageSize"/>]
                    </if>
                </Cell>
            </if>
        </Body>
        <Footer   comment="only used for html output" >
            <Textbox newline="1" pos="rel">
                <Text style="date"><Now /></Text>
            </Textbox>
        </Footer>
    </Doc>
</Report>